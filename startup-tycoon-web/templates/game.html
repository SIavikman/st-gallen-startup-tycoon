{% extends "base.html" %}
{% block content %}

<style>
nav { display: none !important; }
.container { padding-top: 0; }
</style>

<h1>Monat {{ current_month }}/12 - {{ company.owner_name }}'s Startup</h1>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
    <div style="background: {% if company.balance < 0 %}#f8d7da{% else %}#e9ecef{% endif %}; padding: 15px; border-radius: 8px; text-align: center;">
        <h3>üí∞ Balance</h3>
        <p data-balance style="{% if company.balance < 0 %}color: #dc3545; font-weight: bold;{% endif %}">{{ "{:,}".format(company.balance) }} CHF</p>
    </div>
    <div style="background: #e9ecef; padding: 15px; border-radius: 8px; text-align: center;">
        <h3>üë• Customers</h3>
        <p data-customers>{{ company.customers }}</p>
    </div>
    <div style="background: #e9ecef; padding: 15px; border-radius: 8px; text-align: center;">
        <h3>üë®‚Äçüíº Employees</h3>
        <p data-employees>{{ company.employees }}</p>
    </div>
    <div style="background: #e9ecef; padding: 15px; border-radius: 8px; text-align: center;">
        <h3>‚≠ê Reputation</h3>
        <p data-reputation>{{ "%.1f"|format(company.reputation) }}</p>
    </div>
    <div style="background: #e9ecef; padding: 15px; border-radius: 8px; text-align: center;">
        <h3>üìà Product Quality</h3>
        <p data-quality>{{ "%.1f"|format(company.product_quality) }}</p>
    </div>
    <div style="background: #e9ecef; padding: 15px; border-radius: 8px; text-align: center;">
        <h3>üìä Score</h3>
        <p data-score>{{ "{:,}".format(round(company.balance + (company.customers * 10) + (company.reputation * 1000) + (company.product_quality * 1000))) }}</p>
    </div>
</div>

{% if company.balance < 0 and not company.is_bankrupt %}
<!-- Emergency Situation - Schulden -->
<div style="background: #f8d7da; border: 3px solid #dc3545; border-radius: 10px; padding: 20px; margin: 20px 0;">
    <h2 style="color: #dc3545;">‚ö†Ô∏è KRITISCHE SITUATION - Unternehmen in Schulden!</h2>
    <p style="font-size: 1.2em;">Dein Kontostand ist negativ! Du musst dringend handeln:</p>
</div>

<h3>Verf√ºgbare Notfall-Aktionen:</h3>
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin: 20px 0;">
    <div class="action-card emergency" onclick="executeAction('take_loan')" style="border-color: #ffc107; background: #fff3cd;">
        <div style="font-weight: bold; color: #856404;">üèõÔ∏è Emergency Bank Loan</div>
        <div style="color: #856404;">Sofort: +5,000 CHF</div>
        <div style="font-size: 0.9em; color: #856404;">R√ºckzahlung: 2,000 CHF/Monat f√ºr 3 Monate</div>
        <div style="font-size: 0.8em; color: #dc3545; margin-top: 5px;">‚ö†Ô∏è Hohe Zinsen aber gibt dir eine Chance!</div>
    </div>
    
    <div class="action-card emergency" onclick="executeAction('go_bankrupt')" style="border-color: #dc3545; background: #f8d7da;">
        <div style="font-weight: bold; color: #721c24;">üíÄ Bankrott erkl√§ren</div>
        <div style="color: #721c24;">Aufgeben und Firma schlie√üen</div>
        <div style="font-size: 0.9em; color: #721c24;">Spiel ist vorbei!</div>
    </div>
</div>

{% else %}
<!-- Normale Aktionen -->
<h3>Verf√ºgbare Aktionen:</h3>
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin: 20px 0;">
    <div class="action-card {% if company.balance < 1500 %}disabled{% endif %}" onclick="{% if company.balance >= 1500 %}executeAction('marketing'){% endif %}">
        <div style="font-weight: bold;">HSG Campus Marketing</div>
        <div>Kosten: 1,500 CHF</div>
        <div style="font-size: 0.9em; color: #666;">Target wealthy HSG students</div>
        {% if company.balance < 1500 %}
        <div style="font-size: 0.8em; color: #dc3545;">‚ö†Ô∏è Nicht genug Geld!</div>
        {% endif %}
    </div>
    
    <div class="action-card {% if company.balance < 2000 %}disabled{% endif %}" onclick="{% if company.balance >= 2000 %}executeAction('development'){% endif %}">
        <div style="font-weight: bold;">Swiss Quality Development</div>
        <div>Kosten: 2,000 CHF</div>
        <div style="font-size: 0.9em; color: #666;">Meet Swiss quality standards</div>
        {% if company.balance < 2000 %}
        <div style="font-size: 0.8em; color: #dc3545;">‚ö†Ô∏è Nicht genug Geld!</div>
        {% endif %}
    </div>
    
    <div class="action-card {% if company.balance < 3000 %}disabled{% endif %}" onclick="{% if company.balance >= 3000 %}executeAction('hiring'){% endif %}">
        <div style="font-weight: bold;">Recruit Talent</div>
        <div>Kosten: 3,000 CHF</div>
        <div style="font-size: 0.9em; color: #666;">Hire HSG graduates</div>
        {% if company.balance < 3000 %}
        <div style="font-size: 0.8em; color: #dc3545;">‚ö†Ô∏è Nicht genug Geld!</div>
        {% endif %}
    </div>
    
    <div class="action-card {% if company.balance < 1000 %}disabled{% endif %}" onclick="{% if company.balance >= 1000 %}executeAction('research'){% endif %}">
        <div style="font-weight: bold;">Market Research</div>
        <div>Kosten: 1,000 CHF</div>
        <div style="font-size: 0.9em; color: #666;">Study St. Gallen market trends</div>
        {% if company.balance < 1000 %}
        <div style="font-size: 0.8em; color: #dc3545;">‚ö†Ô∏è Nicht genug Geld!</div>
        {% endif %}
    </div>
    
    <div class="action-card {% if company.balance < 4000 %}disabled{% endif %}" onclick="{% if company.balance >= 4000 %}executeAction('expansion'){% endif %}">
        <div style="font-weight: bold;">Regional Expansion</div>
        <div>Kosten: 4,000 CHF</div>
        <div style="font-size: 0.9em; color: #666;">Expand across Eastern Switzerland</div>
        {% if company.balance < 4000 %}
        <div style="font-size: 0.8em; color: #dc3545;">‚ö†Ô∏è Nicht genug Geld!</div>
        {% endif %}
    </div>
    
    <div class="action-card" onclick="executeAction('nothing')">
        <div style="font-weight: bold;">Chill at Drei Weihern</div>
        <div>Kosten: Free</div>
        <div style="font-size: 0.9em; color: #666;">Relax by the lakes</div>
    </div>
</div>
{% endif %}

<!-- Anzeige von aktiven Krediten -->
{% if company.loans %}
<div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 10px; padding: 15px; margin: 20px 0;">
    <h4 style="color: #856404;">üí≥ Aktive Kredite:</h4>
    {% for loan in company.loans %}
    <div style="margin: 10px 0;">
        <strong>Kredit {{ loop.index }}:</strong> 
        Restschuld: {{ "{:,}".format(loan.amount) }} CHF | 
        Monatliche Rate: {{ "{:,}".format(loan.monthly_payment) }} CHF | 
        Verbleibende Monate: {{ loan.months_remaining }}
    </div>
    {% endfor %}
</div>
{% endif %}

<style>
.action-card {
    background: #f8f9fa;
    border: 2px solid #dee2e6;
    border-radius: 10px;
    padding: 15px;
    cursor: pointer;
    transition: all 0.3s;
}
.action-card:hover:not(.disabled) {
    border-color: #007bff;
    transform: translateY(-2px);
}
.action-card.disabled {
    opacity: 0.6;
    cursor: not-allowed;
    background: #e9ecef;
}
.action-card.emergency:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}
</style>

<script>
function showMessage(message, isSuccess = true, callback = null) {
    const messageDiv = document.createElement('div');
    messageDiv.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 20px 30px;
        border-radius: 10px;
        color: white;
        font-weight: bold;
        z-index: 2000;
        max-width: 600px;
        word-wrap: break-word;
        background: ${isSuccess ? '#28a745' : '#dc3545'};
        box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        text-align: left;
        cursor: pointer;
    `;
    messageDiv.innerHTML = message.replace(/\n/g, '<br>') + '<br><br><div style="text-align: center;"><strong>Klicken zum Weiter</strong></div>';
    
    const overlay = document.createElement('div');
    overlay.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.7); z-index: 1999;
    `;
    
    document.body.appendChild(overlay);
    document.body.appendChild(messageDiv);
    
    const removeMessage = () => {
        if (overlay.parentNode) overlay.remove();
        if (messageDiv.parentNode) messageDiv.remove();
        if (callback) callback();
    };
    
    messageDiv.onclick = removeMessage;
    overlay.onclick = removeMessage;
}

function executeAction(actionType) {
    // Disable all action cards
    const buttons = document.querySelectorAll('.action-card');
    buttons.forEach(btn => {
        btn.style.pointerEvents = 'none';
        btn.style.opacity = '0.6';
    });
    
    fetch('/api/complete_turn', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: actionType })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Spezialbehandlung f√ºr Emergency Loan
            if (data.loan_taken) {
                showMessage(
                    '<strong>üèõÔ∏è Notkredit aufgenommen!</strong><br><br>' + data.message + 
                    '<br><br>Du kannst jetzt eine normale Aktion f√ºr diesen Monat w√§hlen!',
                    true, 
                    () => {
                        location.reload(); // Seite neu laden um normale Aktionen zu zeigen
                    }
                );
            } else {
                // Normale Monatszusammenfassung
                const monthSummary = `
                    <strong>üìä Monat ${data.new_month - 1} Zusammenfassung</strong><br><br>
                    <strong>Deine Aktion:</strong><br>
                    ${data.action_result}<br><br>
                    <strong>Was ist passiert:</strong><br>
                    ${data.event_result}<br><br>
                    <strong>Finanzen:</strong><br>
                    ${data.finance_result}
                `;
                
                showMessage(monthSummary, true, () => {
                    if (data.game_over) {
                        window.location.href = '/game_over';
                    } else {
                        location.reload();
                    }
                });
            }
        } else {
            showMessage('Fehler: ' + data.error, false, () => {
                buttons.forEach(btn => {
                    btn.style.pointerEvents = 'auto';
                    btn.style.opacity = '1';
                });
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Netzwerkfehler: ' + error.message, false, () => {
            buttons.forEach(btn => {
                btn.style.pointerEvents = 'auto';
                btn.style.opacity = '1';
            });
        });
    });
}
</script>

{% endblock %}
