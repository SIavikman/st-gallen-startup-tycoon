{% extends "base.html" %}
{% block content %}

<!-- Include animations CSS and JS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/animations.css') }}">
<script src="{{ url_for('static', filename='js/animations.js') }}"></script>

<!-- Hidden main content (shown after animation) -->
<div id="main-content" style="display: none;">
    <div style="text-align: center;">
        <h1>üéâ Game Over!</h1>
        <h2>{{ company.owner_name }}'s Final Results</h2>
        
        <!-- Humorous End Message Section -->
        {% if humorous_message %}
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px; margin: 25px 0; box-shadow: 0 8px 25px rgba(0,0,0,0.15);">
            <h3 style="margin-top: 0; font-size: 1.4em; margin-bottom: 15px;">üì¢ St. Gallen Verdict</h3>
            <p style="font-size: 1.3em; margin: 0; font-weight: 500; line-height: 1.4;">{{ humorous_message|safe }}</p>
        </div>
        {% endif %}
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 30px 0;">
            <div style="background: #e9ecef; padding: 20px; border-radius: 10px; text-align: center;">
                <h3>üèÜ Final Score</h3>
                <p style="font-size: 2em; font-weight: bold; color: #007bff;">{{ "{:,}".format(final_score) }}</p>
            </div>
            <div style="background: #e9ecef; padding: 20px; border-radius: 10px; text-align: center;">
                <h3>üí∞ Final Balance</h3>
                <p style="font-size: 1.5em;">{{ "{:,}".format(company.balance) }} CHF</p>
            </div>
            <div style="background: #e9ecef; padding: 20px; border-radius: 10px; text-align: center;">
                <h3>üë• Customers</h3>
                <p style="font-size: 1.5em;">{{ company.customers }}</p>
            </div>
            <div style="background: #e9ecef; padding: 20px; border-radius: 10px; text-align: center;">
                <h3>üë®‚Äçüíº Employees</h3>
                <p style="font-size: 1.5em;">{{ company.employees }}</p>
            </div>
            <div style="background: #e9ecef; padding: 20px; border-radius: 10px; text-align: center;">
                <h3>‚≠ê Reputation</h3>
                <p style="font-size: 1.5em;">{{ "%.1f"|format(company.reputation) }}</p>
            </div>
            <div style="background: #e9ecef; padding: 20px; border-radius: 10px; text-align: center;">
                <h3>üìà Product Quality</h3>
                <p style="font-size: 1.5em;">{{ "%.1f"|format(company.product_quality) }}</p>
            </div>
        </div>
        
        <!-- Special Achievements Section -->
        {% if achievements %}
        <div style="background: #fff3cd; border: 2px solid #ffeaa7; padding: 20px; border-radius: 10px; margin: 20px 0;">
            <h3 style="margin-top: 0; color: #856404;">üèÖ Special Achievements</h3>
            <div style="display: grid; gap: 10px;">
                {% for achievement in achievements %}
                <div style="background: white; padding: 12px; border-radius: 8px; text-align: left; border-left: 4px solid #ffc107;">
                    <span style="font-size: 1.1em;">{{ achievement|safe }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        {% if company.months_survived >= 12 and not company.is_bankrupt %}
        <div style="background: #d4edda; padding: 20px; border-radius: 10px; margin: 20px 0; border: 2px solid #c3e6cb;">
            <h3>üéä Congratulations!</h3>
            <p style="font-size: 1.2em;">You survived all 12 months in St. Gallen! Your success will be recorded in the leaderboard!</p>
        </div>
        {% elif company.is_bankrupt %}
        <div style="background: #f8d7da; padding: 20px; border-radius: 10px; margin: 20px 0; border: 2px solid #f5c6cb;">
            <h3>üíÄ Bankruptcy!</h3>
            <p style="font-size: 1.2em;">Unfortunately, your startup went bankrupt. Only successful entrepreneurs make it to the leaderboard!</p>
            {% if bankruptcy_message %}
            <div style="margin-top: 15px; padding: 15px; background: rgba(220, 53, 69, 0.1); border-radius: 8px; border-left: 4px solid #dc3545;">
                <p style="margin: 0; font-style: italic; font-size: 1.1em;">{{ bankruptcy_message|safe }}</p>
            </div>
            {% endif %}
        </div>
        {% else %}
        <div style="background: #fff3cd; padding: 20px; border-radius: 10px; margin: 20px 0; border: 2px solid #ffeaa7;">
            <h3>‚è∞ Game Ended Early!</h3>
            <p style="font-size: 1.2em;">You didn't complete all 12 months. Only those who survive the full year make it to the leaderboard!</p>
        </div>
        {% endif %}
        
        <div style="text-align: center; margin-top: 30px;">
            <a href="/leaderboard" class="btn" style="font-size: 18px; padding: 15px 30px;">Go to Leaderboard</a>
            <br><br>
            <a href="/" class="btn" style="font-size: 16px; padding: 12px 25px; background-color: #6c757d; border: none;">Start New Game</a>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Wait a bit until everything is loaded
    setTimeout(() => {
        // Show appropriate animation based on game result
        showGameEndAnimation();
    }, 200);
});

function showGameEndAnimation() {
    // Get game data from template
    const playerName = '{{ company.owner_name }}';
    const finalScore = {{ final_score }};
    const monthsSurvived = {{ company.months_survived }};
    const isBankrupt = {{ 'true' if company.is_bankrupt else 'false' }};
    const humorousMessage = `{{ humorous_message|safe if humorous_message else '' }}`;
    
    // Check if gameAnimations is available
    if (typeof gameAnimations !== 'undefined') {
        // Use the new animation class
        gameAnimations.showGameOver(playerName, finalScore, monthsSurvived, isBankrupt, humorousMessage);
        
        // Override the buttons to use local functions
        setTimeout(() => {
            // Replace onclick handlers of the buttons
            const primaryBtns = document.querySelectorAll('.go-btn.primary, .go-btn.success');
            const secondaryBtns = document.querySelectorAll('.go-btn:not(.primary):not(.success)');
            
            primaryBtns.forEach(btn => {
                btn.onclick = showResults;
            });
            
            secondaryBtns.forEach(btn => {
                btn.onclick = goToLeaderboard;
            });
        }, 500);
    } else {
        // Fallback to old animation if animations.js not loaded
        showFallbackAnimation();
    }
}

function showFallbackAnimation() {
    const overlay = document.createElement('div');
    overlay.className = 'go-overlay is-open';
    
    const humorousMessage = `{{ humorous_message|safe if humorous_message else '' }}`;
    const humorSection = humorousMessage ? `
        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin: 15px 0; border-left: 4px solid #fff;">
            <p style="margin: 0; font-size: 1.1em; font-style: italic;">${humorousMessage}</p>
        </div>
    ` : '';
    
    {% if company.months_survived >= 12 and not company.is_bankrupt %}
    // Success Version
    overlay.innerHTML = `
        <div class="success-card">
            <h1 class="success-title">
                CONGRATULATIONS!
                <span class="sparkle">CONGRATULATIONS!</span>
            </h1>
            <p class="success-sub">{{ company.owner_name }}, you survived all 12 months in St. Gallen!</p>
            ${humorSection}
            <div class="success-pill" style="display: flex;">
                <span class="success-dot"></span>
                <span>Final Score: <strong>{{ "{:,}".format(final_score) }}</strong></span>
            </div>
            <div class="success-actions">
                <button class="go-btn success" onclick="showResults()">View Results</button>
                <button class="go-btn" onclick="goToLeaderboard()">Go to Leaderboard</button>
            </div>
        </div>
    `;
    {% else %}
    // Game Over Version
    overlay.innerHTML = `
        <div class="go-card">
            <h1 class="go-title">
                GAME OVER
                <span class="glitch">GAME OVER</span>
            </h1>
            <p class="go-sub">{{ company.owner_name }}'s St. Gallen Adventure has ended!</p>
            ${humorSection}
            <div class="go-pill" style="display: flex;">
                <span class="go-dot"></span>
                <span>Final Score: <strong>{{ "{:,}".format(final_score) }}</strong></span>
            </div>
            <div class="go-actions">
                <button class="go-btn primary" onclick="showResults()">View Results</button>
                <button class="go-btn" onclick="goToLeaderboard()">Go to Leaderboard</button>
            </div>
        </div>
    `;
    {% endif %}
    
    document.body.appendChild(overlay);
    document.documentElement.style.overflow = 'hidden';
}

function showResults() {
    // Hide animation
    const gameOverlay = document.querySelector('.go-overlay');
    const successOverlay = document.querySelector('.success-overlay');
    
    if (gameOverlay) {
        gameOverlay.classList.remove('is-open');
        setTimeout(() => gameOverlay.remove(), 300);
    }
    if (successOverlay) {
        successOverlay.classList.remove('is-open');
        setTimeout(() => successOverlay.remove(), 300);
    }
    
    document.documentElement.style.overflow = '';
    
    // Show main content
    document.getElementById('main-content').style.display = 'block';
}

function goToLeaderboard() {
    window.location.href = '/leaderboard';
}

// Auto-hide animation after certain time (if user doesn't click)
setTimeout(() => {
    {% if company.months_survived >= 12 and not company.is_bankrupt %}
    // Success: wait 6 seconds
    const overlay = document.querySelector('.success-overlay');
    if (overlay && overlay.classList.contains('is-open')) {
        showResults();
    }
    }, 6000);
    {% else %}
    // Game Over: wait 4 seconds
    const overlay = document.querySelector('.go-overlay');
    if (overlay && overlay.classList.contains('is-open')) {
        showResults();
    }
    }, 4000);
    {% endif %}
</script>

{% endblock %}
