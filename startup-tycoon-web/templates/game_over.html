{% extends "base.html" %}
{% block content %}

<!-- Include animations CSS and JS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/animations.css') }}">
<script src="{{ url_for('static', filename='js/animations.js') }}"></script>

<!-- Versteckter Hauptcontent (wird nach Animation gezeigt) -->
<div id="main-content" style="display: none;">
    <div style="text-align: center;">
        <h1>🎉 Spiel Beendet!</h1>
        <h2>{{ company.owner_name }}'s Endergebnis</h2>
        
        <!-- Humorous End Message Section -->
        {% if humorous_message %}
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px; margin: 25px 0; box-shadow: 0 8px 25px rgba(0,0,0,0.15);">
            <h3 style="margin-top: 0; font-size: 1.4em; margin-bottom: 15px;">📢 St. Galler Urteil</h3>
            <p style="font-size: 1.3em; margin: 0; font-weight: 500; line-height: 1.4;">{{ humorous_message|safe }}</p>
        </div>
        {% endif %}
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 30px 0;">
            <div style="background: #e9ecef; padding: 20px; border-radius: 10px; text-align: center;">
                <h3>🏆 Endpunktzahl</h3>
                <p style="font-size: 2em; font-weight: bold; color: #007bff;">{{ "{:,}".format(final_score) }}</p>
            </div>
            <div style="background: #e9ecef; padding: 20px; border-radius: 10px; text-align: center;">
                <h3>💰 Endkontostand</h3>
                <p style="font-size: 1.5em;">{{ "{:,}".format(company.balance) }} CHF</p>
            </div>
            <div style="background: #e9ecef; padding: 20px; border-radius: 10px; text-align: center;">
                <h3>👥 Kunden</h3>
                <p style="font-size: 1.5em;">{{ company.customers }}</p>
            </div>
            <div style="background: #e9ecef; padding: 20px; border-radius: 10px; text-align: center;">
                <h3>👨‍💼 Mitarbeiter</h3>
                <p style="font-size: 1.5em;">{{ company.employees }}</p>
            </div>
            <div style="background: #e9ecef; padding: 20px; border-radius: 10px; text-align: center;">
                <h3>⭐ Reputation</h3>
                <p style="font-size: 1.5em;">{{ "%.1f"|format(company.reputation) }}</p>
            </div>
            <div style="background: #e9ecef; padding: 20px; border-radius: 10px; text-align: center;">
                <h3>📈 Produktqualität</h3>
                <p style="font-size: 1.5em;">{{ "%.1f"|format(company.product_quality) }}</p>
            </div>
        </div>
        
        <!-- Special Achievements Section -->
        {% if achievements %}
        <div style="background: #fff3cd; border: 2px solid #ffeaa7; padding: 20px; border-radius: 10px; margin: 20px 0;">
            <h3 style="margin-top: 0; color: #856404;">🏅 Besondere Erfolge</h3>
            <div style="display: grid; gap: 10px;">
                {% for achievement in achievements %}
                <div style="background: white; padding: 12px; border-radius: 8px; text-align: left; border-left: 4px solid #ffc107;">
                    <span style="font-size: 1.1em;">{{ achievement|safe }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        {% if company.months_survived >= 12 and not company.is_bankrupt %}
        <div style="background: #d4edda; padding: 20px; border-radius: 10px; margin: 20px 0; border: 2px solid #c3e6cb;">
            <h3>🎊 Herzlichen Glückwunsch!</h3>
            <p style="font-size: 1.2em;">Du hast alle 12 Monate in St. Gallen überlebt! Dein Erfolg wird ins Leaderboard eingetragen!</p>
        </div>
        {% elif company.is_bankrupt %}
        <div style="background: #f8d7da; padding: 20px; border-radius: 10px; margin: 20px 0; border: 2px solid #f5c6cb;">
            <h3>💀 Bankrott!</h3>
            <p style="font-size: 1.2em;">Leider ist dein Startup bankrott gegangen. Nur erfolgreiche Unternehmer schaffen es ins Leaderboard!</p>
            {% if bankruptcy_message %}
            <div style="margin-top: 15px; padding: 15px; background: rgba(220, 53, 69, 0.1); border-radius: 8px; border-left: 4px solid #dc3545;">
                <p style="margin: 0; font-style: italic; font-size: 1.1em;">{{ bankruptcy_message|safe }}</p>
            </div>
            {% endif %}
        </div>
        {% else %}
        <div style="background: #fff3cd; padding: 20px; border-radius: 10px; margin: 20px 0; border: 2px solid #ffeaa7;">
            <h3>⏰ Zu früh beendet!</h3>
            <p style="font-size: 1.2em;">Du hast nicht alle 12 Monate geschafft. Nur wer das ganze Jahr überlebt, kommt ins Leaderboard!</p>
        </div>
        {% endif %}
        
        <div style="text-align: center; margin-top: 30px;">
            <p style="font-size: 1.1em; margin-bottom: 20px;">Du wirst in <span id="countdown">8</span> Sekunden automatisch zum Leaderboard weitergeleitet...</p>
            <a href="/leaderboard" class="btn" style="font-size: 18px; padding: 15px 30px;">Sofort zum Leaderboard</a>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Warte kurz bis alles geladen ist
    setTimeout(() => {
        // Zeige passende Animation basierend auf Spielergebnis
        showGameEndAnimation();
    }, 200);
});

function showGameEndAnimation() {
    // Hole die Spieldaten aus dem Template
    const playerName = '{{ company.owner_name }}';
    const finalScore = {{ final_score }};
    const monthsSurvived = {{ company.months_survived }};
    const isBankrupt = {{ 'true' if company.is_bankrupt else 'false' }};
    const humorousMessage = `{{ humorous_message|safe if humorous_message else '' }}`;
    
    // Prüfe ob gameAnimations verfügbar ist
    if (typeof gameAnimations !== 'undefined') {
        // Verwende die neue Animationsklasse
        gameAnimations.showGameOver(playerName, finalScore, monthsSurvived, isBankrupt, humorousMessage);
        
        // Override die Buttons um lokale Funktionen zu verwenden
        setTimeout(() => {
            // Ersetze die onclick-Handler der Buttons
            const primaryBtns = document.querySelectorAll('.go-btn.primary, .go-btn.success');
            const secondaryBtns = document.querySelectorAll('.go-btn:not(.primary):not(.success)');
            
            primaryBtns.forEach(btn => {
                btn.onclick = showResults;
            });
            
            secondaryBtns.forEach(btn => {
                btn.onclick = goToLeaderboard;
            });
        }, 500);
    } else {
        // Fallback zur alten Animation falls animations.js nicht geladen
        showFallbackAnimation();
    }
}

function showFallbackAnimation() {
    const overlay = document.createElement('div');
    overlay.className = 'go-overlay is-open';
    
    const humorousMessage = `{{ humorous_message|safe if humorous_message else '' }}`;
    const humorSection = humorousMessage ? `
        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin: 15px 0; border-left: 4px solid #fff;">
            <p style="margin: 0; font-size: 1.1em; font-style: italic;">${humorousMessage}</p>
        </div>
    ` : '';
    
    {% if company.months_survived >= 12 and not company.is_bankrupt %}
    // Success Version
    overlay.innerHTML = `
        <div class="success-card">
            <h1 class="success-title">
                GRATULIERE!
                <span class="sparkle">GRATULIERE!</span>
            </h1>
            <p class="success-sub">{{ company.owner_name }}, du hast alle 12 Monate in St. Gallen überlebt!</p>
            ${humorSection}
            <div class="success-pill" style="display: flex;">
                <span class="success-dot"></span>
                <span>Endpunktzahl: <strong>{{ "{:,}".format(final_score) }}</strong></span>
            </div>
            <div class="success-actions">
                <button class="go-btn success" onclick="showResults()">Ergebnisse anzeigen</button>
                <button class="go-btn" onclick="goToLeaderboard()">Zum Leaderboard</button>
            </div>
        </div>
    `;
    {% else %}
    // Game Over Version
    overlay.innerHTML = `
        <div class="go-card">
            <h1 class="go-title">
                GAME OVER
                <span class="glitch">GAME OVER</span>
            </h1>
            <p class="go-sub">{{ company.owner_name }}'s St. Gallen Adventure ist zu Ende!</p>
            ${humorSection}
            <div class="go-pill" style="display: flex;">
                <span class="go-dot"></span>
                <span>Endpunktzahl: <strong>{{ "{:,}".format(final_score) }}</strong></span>
            </div>
            <div class="go-actions">
                <button class="go-btn primary" onclick="showResults()">Ergebnisse anzeigen</button>
                <button class="go-btn" onclick="goToLeaderboard()">Zum Leaderboard</button>
            </div>
        </div>
    `;
    {% endif %}
    
    document.body.appendChild(overlay);
    document.documentElement.style.overflow = 'hidden';
}

function showResults() {
    // Verstecke Animation
    const gameOverlay = document.querySelector('.go-overlay');
    const successOverlay = document.querySelector('.success-overlay');
    
    if (gameOverlay) {
        gameOverlay.classList.remove('is-open');
        setTimeout(() => gameOverlay.remove(), 300);
    }
    if (successOverlay) {
        successOverlay.classList.remove('is-open');
        setTimeout(() => successOverlay.remove(), 300);
    }
    
    document.documentElement.style.overflow = '';
    
    // Zeige Hauptcontent
    document.getElementById('main-content').style.display = 'block';
    
    // Starte Countdown für Leaderboard
    startCountdown();
}

function goToLeaderboard() {
    window.location.href = '/leaderboard';
}

function startCountdown() {
    let countdown = 8;
    const countdownElement = document.getElementById('countdown');
    
    const timer = setInterval(() => {
        countdown--;
        if (countdownElement) {
            countdownElement.textContent = countdown;
        }
        if (countdown <= 0) {
            clearInterval(timer);
            window.location.href = '/leaderboard';
        }
    }, 1000);
    
    // Automatische Weiterleitung nach 8 Sekunden
    setTimeout(() => {
        window.location.href = '/leaderboard';
    }, 8000);
}

// Automatisch Animation nach bestimmter Zeit ausblenden (falls Nutzer nicht klickt)
setTimeout(() => {
    {% if company.months_survived >= 12 and not company.is_bankrupt %}
    // Success: 6 Sekunden warten
    const overlay = document.querySelector('.success-overlay');
    if (overlay && overlay.classList.contains('is-open')) {
        showResults();
    }
    }, 6000);
    {% else %}
    // Game Over: 4 Sekunden warten
    const overlay = document.querySelector('.go-overlay');
    if (overlay && overlay.classList.contains('is-open')) {
        showResults();
    }
    }, 4000);
    {% endif %}
</script>

{% endblock %}
